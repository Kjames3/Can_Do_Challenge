<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viam Rover Control Panel</title>
    <meta name="description" content="Control panel for Viam-powered rover with camera, lidar, and object detection">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =================================================================
           CSS Variables & Reset
           ================================================================= */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;

            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --accent-cyan: #06b6d4;
            --accent-cyan-dark: #0891b2;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;

            --border-color: #475569;
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;

            --transition: 0.2s ease;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* =================================================================
           Layout
           ================================================================= */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: 100%;
        }

        /* =================================================================
           Header
           ================================================================= */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        .status-dot.connecting {
            background: var(--accent-yellow);
        }

        /* Power Stats */
        .power-readout {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            margin-right: 1rem;
        }

        .power-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.1;
        }

        .power-item small {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .power-item span {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .separator {
            width: 1px;
            height: 20px;
            background: var(--border-color);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* =================================================================
           Buttons
           ================================================================= */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-cyan-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* =================================================================
           Cards
           ================================================================= */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all var(--transition);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header .icon {
            font-size: 1.25rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        /* WASD Control Panel */
        .wasd-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            max-width: 220px;
            border: 1px solid var(--border-color);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
            margin: 0.5rem 0;
        }

        .d-btn {
            width: 48px;
            height: 48px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 1.2rem;
            user-select: none;
        }

        .d-btn:active,
        .d-btn.active {
            background: var(--accent-cyan);
            color: #000;
            transform: translateY(2px);
        }

        /* Specific positions */
        #btn-w {
            grid-column: 2;
            grid-row: 1;
        }

        #btn-a {
            grid-column: 1;
            grid-row: 2;
        }

        #btn-s {
            grid-column: 2;
            grid-row: 2;
        }

        #btn-d {
            grid-column: 3;
            grid-row: 2;
        }

        .power-setting {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .power-val {
            font-family: monospace;
            color: var(--accent-green);
        }

        /* reuse slider styling for horizontal power slider */
        input[type=range].h-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        input[type=range].h-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* =================================================================
           Toggle Switch
           ================================================================= */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all var(--transition);
        }

        .toggle.active {
            background: var(--accent-cyan);
        }

        .toggle.active::after {
            left: 25px;
        }

        /* =================================================================
           Grid Layout
           ================================================================= */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 992px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* =================================================================
           Camera Feed
           ================================================================= */
        .camera-feed {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: contain;
            background: #000;
            border-radius: var(--radius-md);
        }

        .camera-placeholder {
            width: 100%;
            aspect-ratio: 4 / 3;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* =================================================================
           Detection Panel
           ================================================================= */
        .detection-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .detection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .detection-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .detection-count strong {
            color: var(--accent-cyan);
            font-size: 1.25rem;
        }

        .detection-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .detection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
        }

        .detection-item-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detection-badge {
            padding: 0.25rem 0.5rem;
            background: var(--accent-cyan);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .detection-item-stats {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
        }

        .confidence-bar {
            width: 50px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--accent-green);
            border-radius: 3px;
            transition: width var(--transition);
        }

        .no-detections {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* =================================================================
           Motor Readouts
           ================================================================= */
        .motor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .motor-card {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .motor-card h3 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .motor-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .motor-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* =================================================================
           Motor Controls
           ================================================================= */
        .control-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .sliders-container {
            display: flex;
            justify-content: center;
            gap: 3rem;
            width: 100%;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .slider-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Custom Vertical Range Input */
        .vertical-slider {
            -webkit-appearance: none;
            width: 80px;
            /* Wider as requested */
            height: 300px;
            /* Taller */
            background: transparent;
            cursor: pointer;
            writing-mode: bt-lr;
            /* IE/Edge */
            -webkit-appearance: slider-vertical;
            /* Webkit */
            appearance: slider-vertical;
            /* Note: "appearance: slider-vertical" often overrides standard styling. 
               For a truly custom look matching the image (pill shape, fill), 
               we often need a wrapper or simpler cross-browser tricks. 
               However, standard range with rotation or vertical orient is tricky. 
               Let's try a transform approach for maximum styling control if native vertical fails styling.
               Actually, standard practice for "pill" sliders is often rotated horizontal sliders 
               OR just standard vertical inputs with limited styling. 
               Given "High Quality", I will use a rotated horizontal slider approach via a wrapper 
               to ensure I can get the "track" and "fill" look exactly right on all browsers. 
             */
            display: none;
            /* We will replace the visible inputs with our custom structure below, 
                             or strictly style these if possible. */
        }

        /* 
           Simulating Vertical Sliders using Rotated Inputs is often more reliable for styling 
           than 'appearance: slider-vertical'. 
        */

        .slider-wrapper {
            position: relative;
            width: 80px;
            height: 300px;
            background: var(--bg-secondary);
            border-radius: 40px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-color);
        }

        .slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--accent-green), #4ade80);
            border-radius: 40px;
            opacity: 0.8;
            pointer-events: none;
            /* Height set by JS */
            height: 50%;
            transition: height 0.1s ease, background-color 0.2s;
        }

        .slider-input {
            position: absolute;
            width: 300px;
            /* Height of the wrapper */
            height: 80px;
            /* Width of the wrapper */
            transform: rotate(-90deg);
            transform-origin: center;
            opacity: 0;
            /* Invisible interaction layer */
            cursor: pointer;
            z-index: 2;
        }

        /* Thumb visualization (optional, if we want a separate thumb element) */
        .slider-thumb {
            position: absolute;
            left: 50%;
            width: 70px;
            height: 70px;
            background: #e2e8f0;
            border: 2px solid #cbd5e1;
            border-radius: 20px;
            transform: translate(-50%, 50%);
            /* Start centered vertically */
            bottom: 50%;
            /* Adjusted by JS */
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1;
            transition: bottom 0.1s ease;
        }

        .slider-value {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 1rem;
        }

        #auto-drive-wrapper {
            width: 100%;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 0;
            /* Hidden by default */
            opacity: 0;
        }

        #auto-drive-wrapper.visible {
            max-height: 200px;
            opacity: 1;
            margin-top: 1rem;
        }

        .stop-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--accent-red), #b91c1c);
            border: 4px solid #991b1b;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
        }

        .stop-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(239, 68, 68, 0.4);
        }

        .stop-btn:active {
            transform: scale(0.98);
        }

        /* =================================================================
           Lidar
           ================================================================= */
        .lidar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lidar-canvas {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            background: #000;
            border-radius: var(--radius-md);
        }

        .lidar-scale {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* =================================================================
           Controller Status
           ================================================================= */
        .controller-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .controller-icon {
            font-size: 1.25rem;
        }

        .controller-info {
            flex: 1;
        }

        .controller-info-name {
            font-weight: 500;
        }

        .controller-info-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* =================================================================
           Utilities
           ================================================================= */
        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .disabled-overlay {
            opacity: 0.4;
            pointer-events: none;
        }

        /* =================================================================
           Scrollbar
           ================================================================= */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <div class="logo">ðŸ¤–</div>
                <h1>Viam Rover Control</h1>
            </div>

            <div class="connection-status">
                <div id="power-stats" class="power-readout" style="display: none;">
                    <div class="power-item">
                        <small>Volts</small>
                        <span id="stat-volts">-- V</span>
                    </div>
                    <div class="separator"></div>
                    <div class="power-item">
                        <small>Amps</small>
                        <span id="stat-amps">-- A</span>
                    </div>
                    <div class="separator"></div>
                    <div class="power-item">
                        <small>Power</small>
                        <span id="stat-watts">-- W</span>
                    </div>
                </div>

                <div class="status-indicator">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="status-text">Disconnected</span>
                </div>
                <!-- IP Input -->
                <input type="text" id="robot-ip" placeholder="Robot IP" value="192.168.1.X"
                    style="padding: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); margin-right: 0.5rem; width: 140px;">
                <button id="connect-btn" class="btn btn-primary">Connect</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Left Column: Camera & Detection -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon">ðŸ“¹</span> Camera Feed</h2>
                        <div class="toggle-wrapper">
                            <span class="toggle-label">Detection</span>
                            <div id="detection-toggle" class="toggle" title="Toggle object detection"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <img id="camera-feed" class="camera-feed" alt="Camera feed" style="display: none;">
                        <div id="camera-placeholder" class="camera-placeholder">
                            Waiting for camera feed...
                        </div>

                        <!-- Detection Results -->
                        <div id="detection-panel" class="detection-panel" style="display: none;">
                            <div class="detection-header">
                                <span class="detection-count">
                                    <strong id="detection-count">0</strong> objects detected
                                </span>
                            </div>
                            <div id="detection-list" class="detection-list">
                                <div class="no-detections">No objects detected</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motor Controls -->
                <div class="card mt-2">
                    <div class="card-header">
                        <h2><span class="icon">ðŸŽ®</span> Motor Control</h2>
                    </div>
                    <div class="card-body">
                        <div class="control-section">
                            <div class="sliders-container">
                                <div class="slider-group">
                                    <span class="slider-label">LEFT</span>
                                    <div class="slider-wrapper">
                                        <div class="slider-fill" id="left-fill" style="bottom: 50%; height: 0%;"></div>
                                        <div class="slider-thumb" id="left-thumb" style="bottom: 50%;"></div>
                                        <input type="range" id="left-slider" class="slider-input" min="-100" max="100"
                                            value="0" step="1">
                                    </div>
                                    <span id="left-slider-value" class="slider-value">0</span>
                                </div>

                                <div
                                    style="display: flex; flex-direction: column; gap: 1rem; align-items: center; z-index: 10;">
                                    <button id="stop-btn" class="stop-btn">STOP</button>
                                    <div id="auto-drive-wrapper">
                                        <button id="auto-drive-btn" class="btn btn-primary" style="width: 100%;">
                                            Start Auto-Drive
                                        </button>
                                    </div>

                                    <!-- WASD Panel -->
                                    <div class="wasd-panel">
                                        <div class="control-header">
                                            <span>Quick move</span>
                                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                                <small style="font-size:0.7rem;">WASD</small>
                                                <label class="switch">
                                                    <input type="checkbox" id="keyboard-toggle">
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="d-pad">
                                            <button class="d-btn" id="btn-w">â†‘</button>
                                            <button class="d-btn" id="btn-a">â†¶</button>
                                            <button class="d-btn" id="btn-s">â†“</button>
                                            <button class="d-btn" id="btn-d">â†·</button>
                                        </div>

                                        <div class="power-setting">
                                            <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                                                <span>Power</span>
                                                <span id="key-power-val" class="power-val">0.5</span>
                                            </div>
                                            <input type="range" id="key-power" class="h-slider" min="0.1" max="1.0"
                                                step="0.1" value="0.5">
                                        </div>
                                    </div>
                                </div>

                                <div class="slider-group">
                                    <span class="slider-label">RIGHT</span>
                                    <div class="slider-wrapper">
                                        <div class="slider-fill" id="right-fill" style="bottom: 50%; height: 0%;"></div>
                                        <div class="slider-thumb" id="right-thumb" style="bottom: 50%;"></div>
                                        <input type="range" id="right-slider" class="slider-input" min="-100" max="100"
                                            value="0" step="1">
                                    </div>
                                    <span id="right-slider-value" class="slider-value">0</span>
                                </div>
                            </div>

                            <!-- Controller Status -->
                            <div id="controller-status" class="controller-status">
                                <span class="controller-icon">ðŸŽ®</span>
                                <div class="controller-info">
                                    <div id="controller-name" class="controller-info-name text-muted">No controller
                                        detected</div>
                                    <div class="controller-info-hint">Use Right Stick to drive â€¢ X button for E-Stop
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Sidebar -->
            <div class="sidebar" id="control-area">
                <!-- Motor Readouts -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon">ðŸ“Š</span> Motor Status</h2>
                    </div>
                    <div class="card-body">
                        <div class="motor-grid">
                            <div class="motor-card">
                                <h3>Left Motor</h3>
                                <div id="left-pos" class="motor-value">0.00</div>
                                <div class="motor-label">Position (rev)</div>
                                <div id="left-power" class="motor-value mt-1">0%</div>
                                <div class="motor-label">Power</div>
                            </div>
                            <div class="motor-card">
                                <h3>Right Motor</h3>
                                <div id="right-pos" class="motor-value">0.00</div>
                                <div class="motor-label">Position (rev)</div>
                                <div id="right-power" class="motor-value mt-1">0%</div>
                                <div class="motor-label">Power</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lidar -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon">ðŸ“¡</span> Lidar View</h2>
                        <div class="toggle-wrapper">
                            <span class="toggle-label">Enable</span>
                            <div id="lidar-toggle" class="toggle"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="lidar-container">
                            <canvas id="lidar-canvas" class="lidar-canvas" width="300" height="300"></canvas>
                            <span class="lidar-scale">100px = 1 meter</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // Application State
        // =================================================================
        const state = {
            ws: null,
            connected: false,
            detectionEnabled: false,
            lidarEnabled: false,
            gamepadIndex: null,
            lastLeftPower: 0,
            lastRightPower: 0,
            isAutoDriving: false
        };

        const SERVER_ADDRESS = "ws://localhost:8081";

        // =================================================================
        // DOM Elements
        // =================================================================
        const elements = {
            // Connection
            connectBtn: document.getElementById('connect-btn'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            controlArea: document.getElementById('control-area'),

            // Camera & Detection
            cameraFeed: document.getElementById('camera-feed'),
            cameraPlaceholder: document.getElementById('camera-placeholder'),
            detectionToggle: document.getElementById('detection-toggle'),
            detectionPanel: document.getElementById('detection-panel'),
            detectionCount: document.getElementById('detection-count'),
            detectionList: document.getElementById('detection-list'),
            autoDriveBtn: document.getElementById('auto-drive-btn'),

            // Power Stats
            powerStatsPanel: document.getElementById('power-stats'),
            statVolts: document.getElementById('stat-volts'),
            statAmps: document.getElementById('stat-amps'),
            statWatts: document.getElementById('stat-watts'),



            // Lidar
            lidarToggle: document.getElementById('lidar-toggle'),
            lidarCanvas: document.getElementById('lidar-canvas'),
            lidarCtx: document.getElementById('lidar-canvas').getContext('2d'),

            // Motors
            leftSlider: document.getElementById('left-slider'),
            leftSliderValue: document.getElementById('left-slider-value'),
            leftFill: document.getElementById('left-fill'),
            leftThumb: document.getElementById('left-thumb'),

            rightSlider: document.getElementById('right-slider'),
            rightSliderValue: document.getElementById('right-slider-value'),
            rightFill: document.getElementById('right-fill'),
            rightThumb: document.getElementById('right-thumb'),

            stopBtn: document.getElementById('stop-btn'),

            autoDriveWrapper: document.getElementById('auto-drive-wrapper'),

            // WSAD / D-Pad
            btnW: document.getElementById('btn-w'),
            btnA: document.getElementById('btn-a'),
            btnS: document.getElementById('btn-s'),
            btnD: document.getElementById('btn-d'),
            keyboardToggle: document.getElementById('keyboard-toggle'),
            keyPower: document.getElementById('key-power'),
            keyPowerVal: document.getElementById('key-power-val'),

            leftPos: document.getElementById('left-pos'),
            leftPower: document.getElementById('left-power'),
            rightPos: document.getElementById('right-pos'),
            rightPower: document.getElementById('right-power'),

            // Controller
            controllerName: document.getElementById('controller-name')
        };

        // =================================================================
        // WebSocket Connection
        // =================================================================
        function connect() {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) return;

            updateConnectionStatus('connecting');
            const ip = document.getElementById('robot-ip').value || 'localhost';
            console.log(`Connecting to ws://${ip}:8081`);
            state.ws = new WebSocket(`ws://${ip}:8081`);

            state.ws.onopen = () => {
                state.connected = true;
                updateConnectionStatus('connected');
                elements.controlArea.classList.remove('disabled-overlay');
            };

            state.ws.onclose = () => {
                state.connected = false;
                updateConnectionStatus('disconnected');
                elements.controlArea.classList.add('disabled-overlay');
                state.ws = null;
            };

            state.ws.onerror = () => {
                state.connected = false;
                updateConnectionStatus('error');
                elements.controlArea.classList.add('disabled-overlay');
                state.ws = null;
            };

            state.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "readout") {
                        handleReadout(data);
                    }
                } catch (e) {
                    console.error("Message parse error:", e);
                }
            };
        }

        function updateConnectionStatus(status) {
            elements.statusDot.className = 'status-dot';

            switch (status) {
                case 'connected':
                    elements.statusDot.classList.add('connected');
                    elements.statusText.textContent = 'Connected';
                    elements.connectBtn.textContent = 'Connected';
                    elements.connectBtn.disabled = true;
                    break;
                case 'connecting':
                    elements.statusDot.classList.add('connecting');
                    elements.statusText.textContent = 'Connecting...';
                    elements.connectBtn.textContent = 'Connecting...';
                    elements.connectBtn.disabled = true;
                    break;
                case 'error':
                    elements.statusText.textContent = 'Connection failed';
                    elements.connectBtn.textContent = 'Retry';
                    elements.connectBtn.disabled = false;
                    break;
                default:
                    elements.statusText.textContent = 'Disconnected';
                    elements.connectBtn.textContent = 'Connect';
                    elements.connectBtn.disabled = false;
            }
        }

        function sendMessage(data) {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify(data));
            }
        }

        // =================================================================
        // Data Handlers
        // =================================================================
        function handleReadout(data) {
            // Update motor readouts
            elements.leftPos.textContent = data.left_pos.toFixed(2);
            elements.leftPower.textContent = `${Math.round(data.left_power * 100)}%`;
            elements.rightPos.textContent = data.right_pos.toFixed(2);
            elements.rightPower.textContent = `${Math.round(data.right_power * 100)}%`;

            // Update camera feed
            if (data.image) {
                elements.cameraFeed.src = "data:image/jpeg;base64," + data.image;
                elements.cameraFeed.style.display = 'block';
                elements.cameraPlaceholder.style.display = 'none';
            }

            // Update detections
            if (data.detections !== undefined) {
                updateDetections(data.detections);
            }

            // Update detection toggle state from server
            if (data.detection_enabled !== undefined) {
                state.detectionEnabled = data.detection_enabled;
                elements.detectionToggle.classList.toggle('active', state.detectionEnabled);
                elements.detectionPanel.style.display = state.detectionEnabled ? 'block' : 'none';
            }

            // Update Auto-Driving Button State
            if (data.is_auto_driving !== undefined) {
                state.isAutoDriving = data.is_auto_driving;
                updateAutoDriveButton();
            }

            // Update lidar
            if (data.lidar_points && state.lidarEnabled) {
                drawLidar(data.lidar_points);
            }

            // Update Battery / Power Stats
            if (data.battery) {
                elements.powerStatsPanel.style.display = 'flex';
                elements.statVolts.textContent = data.battery.voltage.toFixed(2) + ' V';
                elements.statAmps.textContent = data.battery.amps.toFixed(3) + ' A';
                elements.statWatts.textContent = data.battery.watts.toFixed(2) + ' W';
            }
        }

        function updateDetections(detections) {
            elements.detectionCount.textContent = detections.length;

            if (detections.length === 0) {
                elements.detectionList.innerHTML = '<div class="no-detections">No objects detected</div>';
                return;
            }

            const html = detections.map(d => `
                <div class="detection-item">
                    <div class="detection-item-label">
                        <span class="detection-badge">${d.label}</span>
                    </div>
                    <div class="detection-item-stats">
                        <span title="Distance">${d.distance_cm.toFixed(0)}cm</span>
                        <span title="Confidence">${(d.confidence * 100).toFixed(0)}%</span>
                        <div class="confidence-bar" title="Confidence">
                            <div class="confidence-fill" style="width: ${d.confidence * 100}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            elements.detectionList.innerHTML = html;
        }

        // =================================================================
        // Lidar Rendering
        // =================================================================
        function drawLidar(points) {
            const canvas = elements.lidarCanvas;
            const ctx = elements.lidarCtx;
            const width = canvas.width;
            const height = canvas.height;
            const cx = width / 2;
            const cy = height / 2;
            const scale = 75; // pixels per meter

            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            // Draw grid
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 1;

            // Concentric circles (1m, 2m)
            [1, 2].forEach(r => {
                ctx.beginPath();
                ctx.arc(cx, cy, r * scale, 0, Math.PI * 2);
                ctx.stroke();
            });

            // Cross lines
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(width, cy);
            ctx.moveTo(cx, 0);
            ctx.lineTo(cx, height);
            ctx.stroke();

            // Draw points
            ctx.fillStyle = '#22c55e';
            points.forEach(point => {
                const x = cx - (point[1] * scale);
                const y = cy - (point[0] * scale);
                ctx.fillRect(x - 1, y - 1, 2, 2);
            });

            // Draw robot center
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(cx, cy, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        function updateAutoDriveButton() {
            if (state.isAutoDriving) {
                elements.autoDriveBtn.textContent = "Stop Auto-Drive";
                elements.autoDriveBtn.classList.add("btn-danger");
                elements.autoDriveBtn.classList.remove("btn-primary");
            } else {
                elements.autoDriveBtn.textContent = "Start Auto-Drive";
                elements.autoDriveBtn.classList.remove("btn-danger");
                elements.autoDriveBtn.classList.add("btn-primary");
            }
        }

        // =================================================================
        // Motor Control
        // =================================================================
        function handleSliderInput(event) {
            const slider = event.target;
            const power = parseFloat(slider.value) / 100;
            const motorId = slider.id.includes('left') ? 'left' : 'right';

            if (motorId === 'left') {
                elements.leftSliderValue.textContent = slider.value;
            } else {
                elements.rightSliderValue.textContent = slider.value;
            }

            sendMessage({
                type: "set_power",
                motor: motorId,
                power: power
            });
        }

        function stopMotors() {
            sendMessage({ type: "stop" });

            elements.leftSlider.value = 0;
            elements.rightSlider.value = 0;
            elements.leftSliderValue.textContent = '0';
            elements.rightSliderValue.textContent = '0';
        }

        // =================================================================
        // Toggle Handlers
        // =================================================================
        function toggleDetection() {
            state.detectionEnabled = !state.detectionEnabled;
            elements.detectionToggle.classList.toggle('active', state.detectionEnabled);
            elements.detectionPanel.style.display = state.detectionEnabled ? 'block' : 'none';

            sendMessage({
                type: "toggle_detection",
                enabled: state.detectionEnabled
            });
        }

        function toggleLidar() {
            state.lidarEnabled = !state.lidarEnabled;
            elements.lidarToggle.classList.toggle('active', state.lidarEnabled);

            if (!state.lidarEnabled) {
                // Clear canvas when disabled
                const ctx = elements.lidarCtx;
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, elements.lidarCanvas.width, elements.lidarCanvas.height);
            }
        }

        // =================================================================
        // Gamepad Support
        // =================================================================
        let gamepadPollingInterval = null;

        window.addEventListener("gamepadconnected", (e) => {
            state.gamepadIndex = e.gamepad.index;
            elements.controllerName.textContent = e.gamepad.id.substring(0, 30);
            elements.controllerName.classList.remove('text-muted');
            elements.controllerName.style.color = 'var(--accent-green)';

            if (!gamepadPollingInterval) {
                gamepadPollingInterval = setInterval(pollGamepad, 50);
            }
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            if (state.gamepadIndex === e.gamepad.index) {
                state.gamepadIndex = null;
                elements.controllerName.textContent = 'Controller disconnected';
                elements.controllerName.style.color = 'var(--accent-red)';
                stopMotors();
            }
        });

        function pollGamepad() {
            if (state.gamepadIndex === null || !state.connected) return;

            const gamepad = navigator.getGamepads()[state.gamepadIndex];
            if (!gamepad) return;

            // E-Stop (X/A button)
            if (gamepad.buttons[0].pressed) {
                stopMotors();
                return;
            }

            // Right stick for arcade drive
            const deadzone = 0.1;
            let rx = gamepad.axes[2];
            let ry = gamepad.axes[3];

            if (Math.abs(rx) < deadzone) rx = 0;
            if (Math.abs(ry) < deadzone) ry = 0;

            const throttle = -ry;
            const turn = rx;

            let leftPower = Math.max(-1, Math.min(1, throttle + turn));
            let rightPower = Math.max(-1, Math.min(1, throttle - turn));

            // Only send if changed significantly
            if (Math.abs(leftPower - state.lastLeftPower) > 0.02 ||
                Math.abs(rightPower - state.lastRightPower) > 0.02) {

                sendMessage({ type: "set_power", motor: "left", power: leftPower });
                sendMessage({ type: "set_power", motor: "right", power: rightPower });

                state.lastLeftPower = leftPower;
                state.lastRightPower = rightPower;

                // Update UI
                elements.leftSlider.value = Math.round(leftPower * 100);
                elements.rightSlider.value = Math.round(rightPower * 100);
                elements.leftSliderValue.textContent = elements.leftSlider.value;
                elements.rightSliderValue.textContent = elements.rightSlider.value;
            }
        }

        function updateVisuals(value, fill, thumb) {
            // Value is -100 to 100
            // Normalize to 0-1 range for position
            const pct = (parseInt(value) + 100) / 200;
            const pctString = (pct * 100) + "%";

            // Move thumb
            thumb.style.bottom = pctString;

            // Adjust Fill (Center-Zero logic)
            // Center is 50%
            if (value >= 0) {
                fill.style.bottom = "50%";
                fill.style.height = (value / 2) + "%";
                fill.style.backgroundColor = "var(--accent-green)"; // Positive color
            } else {
                // Negative
                // Bottom is current % position, Height is abs(value)/2
                // e.g. -50% -> val=-50 -> pct=25% -> bottom=25%, height=25% (reaching 50%)
                // Wait, simpler:
                // fill.style.bottom = (50 - abs(val)/2) % ? No.
                // Just set top/bottom based on range.
                // It's easier to anchor to 50% and grow Down?
                // But structure is absolute bottom.
                // Let's use Top/Bottom/Height calc.

                // If negative: Bottom = (pct * 100)%, Height = (Math.abs(value)/2)%
                const absVal = Math.abs(value);
                fill.style.bottom = pctString;
                fill.style.height = (absVal / 2) + "%";
                fill.style.backgroundColor = "var(--accent-cyan)"; // Negative color
            }
        }

        // =================================================================
        // Event Listeners
        // =================================================================

        // Connect
        elements.connectBtn.addEventListener('click', () => {
            if (state.connected) {
                state.ws.close();
            } else {
                connect();
            }
        });

        // Motor Control (Sliders)
        function updateMotor(motor, value) {
            if (!state.connected || state.isAutoDriving) return;

            const power = value / 100.0;
            const msg = {
                type: "set_power",
                motor: motor,
                power: power
            };

            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify(msg));
            }
        }

        elements.leftSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            elements.leftSliderValue.textContent = val;
            updateVisuals(val, elements.leftFill, elements.leftThumb);
            updateMotor('left', parseInt(val));
        });

        elements.leftSlider.addEventListener('change', (e) => {
            // Optional: Return to 0 on release? User preference.
            // For now, it stays where you put it.
        });

        elements.rightSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            elements.rightSliderValue.textContent = val;
            updateVisuals(val, elements.rightFill, elements.rightThumb);
            updateMotor('right', parseInt(val));
        });

        // Initialize visuals
        updateVisuals(0, elements.leftFill, elements.leftThumb);
        updateVisuals(0, elements.rightFill, elements.rightThumb);

        // Stop Button
        elements.stopBtn.addEventListener('click', () => {
            if (!state.connected) return;

            // Send stop command
            state.ws.send(JSON.stringify({ type: "stop" }));

            // Also stop auto-drive if active
            if (state.isAutoDriving) {
                state.ws.send(JSON.stringify({ type: "stop_auto_drive" }));
            }

            // Reset UI
            elements.leftSlider.value = 0;
            elements.leftSliderValue.textContent = "0";
            updateVisuals(0, elements.leftFill, elements.leftThumb);

            elements.rightSlider.value = 0;
            elements.rightSliderValue.textContent = "0";
            updateVisuals(0, elements.rightFill, elements.rightThumb);
        });


        // Auto Drive Button
        elements.autoDriveBtn.addEventListener('click', () => {
            if (!state.connected) return;

            const msgType = state.isAutoDriving ? "stop_auto_drive" : "start_auto_drive";
            state.ws.send(JSON.stringify({ type: msgType }));
        });

        // Toggles
        elements.detectionToggle.addEventListener('click', () => {
            if (!state.connected) return;

            const newState = !state.detectionEnabled;
            // Optimistically update
            state.detectionEnabled = newState;
            elements.detectionToggle.classList.toggle('active', newState);

            // Toggle Auto-Drive Button
            if (newState) {
                elements.autoDriveWrapper.classList.add('visible');
            } else {
                elements.autoDriveWrapper.classList.remove('visible');
                // Also stop auto-drive if we disabled detection?
                // Typically yes, but user might want manual control.
                // Let's leave state alone but hide button.
            }

            state.ws.send(JSON.stringify({
                type: "toggle_detection",
                enabled: newState
            }));
        });

        elements.lidarToggle.addEventListener('click', () => {
            state.lidarEnabled = !state.lidarEnabled;
            elements.lidarToggle.classList.toggle('active', state.lidarEnabled);
        });

        // =================================================================
        // Initialization
        // =================================================================
        // Check for gamepad connection
        window.addEventListener("gamepadconnected", (e) => {
            state.gamepadIndex = e.gamepad.index;
            document.getElementById('controller-name').textContent = e.gamepad.id; // Corrected ID
            document.getElementById('controller-status').style.background = "var(--bg-secondary)";
            // Start polling
            requestAnimationFrame(gamepadLoop);
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            state.gamepadIndex = null;
            document.getElementById('controller-name').textContent = "No controller detected";
            document.getElementById('controller-status').style.background = "var(--bg-tertiary)";
        });

        function gamepadLoop() {
            if (state.gamepadIndex !== null) {
                const gp = navigator.getGamepads()[state.gamepadIndex];
                if (gp) {
                    // Right Stick Y-axis (Index 3) for forward/back
                    // Right Stick X-axis (Index 2) for turn
                    // NOTE: Axis values are -1 to 1.
                    // Y: -1 is Up (usually), 1 is Down

                    const fwd = -gp.axes[3]; // Invert so Up is positive
                    const turn = gp.axes[2];

                    // Deadzone
                    const deadzone = 0.1;
                    const cleanFwd = Math.abs(fwd) < deadzone ? 0 : fwd;
                    const cleanTurn = Math.abs(turn) < deadzone ? 0 : turn;

                    // Mixing (Arcade Drive)
                    // Left = Fwd + Turn
                    // Right = Fwd - Turn
                    let left = cleanFwd + cleanTurn;
                    let right = cleanFwd - cleanTurn;

                    // Clamp
                    left = Math.max(Math.min(left, 1), -1);
                    right = Math.max(Math.min(right, 1), -1);

                    // Emergency Stop (Button 0 = Cross/A)
                    if (gp.buttons[0].pressed) {
                        // Emergency Stop or Cross
                        if (state.connected) {
                            state.ws.send(JSON.stringify({ type: "stop" }));
                            if (state.isAutoDriving) {
                                state.ws.send(JSON.stringify({ type: "stop_auto_drive" }));
                            }
                            elements.leftSlider.value = 0;
                            elements.leftSliderValue.textContent = "0";
                            updateVisuals(0, elements.leftFill, elements.leftThumb);
                            elements.rightSlider.value = 0;
                            elements.rightSliderValue.textContent = "0";
                            updateVisuals(0, elements.rightFill, elements.rightThumb);
                        }
                    } else if (!state.isAutoDriving && (Math.abs(left) > 0.05 || Math.abs(right) > 0.05)) {
                        // Only send if stick moved and NOT auto-driving
                        // Update UI sliders too
                        const lVal = Math.round(left * 100);
                        const rVal = Math.round(right * 100);

                        elements.leftSlider.value = lVal;
                        elements.leftSliderValue.textContent = lVal;
                        updateVisuals(lVal, elements.leftFill, elements.leftThumb);

                        elements.rightSlider.value = rVal;
                        elements.rightSliderValue.textContent = rVal;
                        updateVisuals(rVal, elements.rightFill, elements.rightThumb);

                        const msg = { type: "set_power", motor: "left", power: left };
                        const msg2 = { type: "set_power", motor: "right", power: right };

                        if (state.connected && state.ws && state.ws.readyState === WebSocket.OPEN) {
                            state.ws.send(JSON.stringify(msg));
                            state.ws.send(JSON.stringify(msg2));
                        }
                    }
                }
                requestAnimationFrame(gamepadLoop);
            }
        }

        // =================================================================
        // WASD / D-PAD LOGIC
        // =================================================================

        // Power Slider
        elements.keyPower.addEventListener('input', (e) => {
            elements.keyPowerVal.textContent = e.target.value;
        });

        // Helper to send move command
        function sendMove(leftMult, rightMult) {
            if (!state.connected || state.isAutoDriving) return;

            const basePower = parseFloat(elements.keyPower.value);
            const lPwr = basePower * leftMult;
            const rPwr = basePower * rightMult;

            // Update UI sliders to reflect what's happening
            const lVal = Math.round(lPwr * 100);
            const rVal = Math.round(rPwr * 100);

            elements.leftSlider.value = lVal;
            elements.leftSliderValue.textContent = lVal;
            updateVisuals(lVal, elements.leftFill, elements.leftThumb);

            elements.rightSlider.value = rVal;
            elements.rightSliderValue.textContent = rVal;
            updateVisuals(rVal, elements.rightFill, elements.rightThumb);

            // Send
            const msg1 = { type: "set_power", motor: "left", power: lPwr };
            const msg2 = { type: "set_power", motor: "right", power: rPwr };

            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify(msg1));
                state.ws.send(JSON.stringify(msg2));
            }
        }

        function stopMove() {
            if (!state.connected) return;
            // Stop
            state.ws.send(JSON.stringify({ type: "stop" }));

            // Reset UI
            elements.leftSlider.value = 0;
            elements.leftSliderValue.textContent = "0";
            updateVisuals(0, elements.leftFill, elements.leftThumb);
            elements.rightSlider.value = 0;
            elements.rightSliderValue.textContent = "0";
            updateVisuals(0, elements.rightFill, elements.rightThumb);
        }

        // D-Pad Mouse Events
        const dPadButtons = [
            { el: elements.btnW, l: 1, r: 1 },    // Forward
            { el: elements.btnS, l: -1, r: -1 },  // Backward
            { el: elements.btnA, l: -1, r: 1 },   // Left (Pivot)
            { el: elements.btnD, l: 1, r: -1 }    // Right (Pivot)
        ];

        dPadButtons.forEach(btn => {
            // Mouse
            btn.el.addEventListener('mousedown', () => sendMove(btn.l, btn.r));
            btn.el.addEventListener('mouseup', stopMove);
            btn.el.addEventListener('mouseleave', stopMove);

            // Touch
            btn.el.addEventListener('touchstart', (e) => { e.preventDefault(); sendMove(btn.l, btn.r); });
            btn.el.addEventListener('touchend', (e) => { e.preventDefault(); stopMove(); });
        });

        // Keyboard Events
        const keysPressed = {};

        window.addEventListener('keydown', (e) => {
            if (!state.connected || state.isAutoDriving) return;
            // Only if toggle is ON
            if (!elements.keyboardToggle.checked) return;

            const key = e.key.toLowerCase();
            if (keysPressed[key]) return; // Ignore repeat
            keysPressed[key] = true;

            // Prioritize: W/S > A/D
            // Simple mapping for verification
            if (key === 'w' || key === 'arrowup') {
                elements.btnW.classList.add('active');
                sendMove(1, 1);
            } else if (key === 's' || key === 'arrowdown') {
                elements.btnS.classList.add('active');
                sendMove(-1, -1);
            } else if (key === 'a' || key === 'arrowleft') {
                elements.btnA.classList.add('active');
                sendMove(-1, 1); // Pivot Left
            } else if (key === 'd' || key === 'arrowright') {
                elements.btnD.classList.add('active');
                sendMove(1, -1); // Pivot Right
            }
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            keysPressed[key] = false;

            // Remove active classes
            if (key === 'w' || key === 'arrowup') elements.btnW.classList.remove('active');
            if (key === 's' || key === 'arrowdown') elements.btnS.classList.remove('active');
            if (key === 'a' || key === 'arrowleft') elements.btnA.classList.remove('active');
            if (key === 'd' || key === 'arrowright') elements.btnD.classList.remove('active');

            // If toggle is off, ignore
            if (!elements.keyboardToggle.checked) return;

            // Simple stop on key up logic might be glitchy if multiple keys held.
            // For robust WASD, usually check state of all keys.
            // But for simple "Quick move", we usually just stop if the primary key is lifted.
            // Or check if ANY move keys are still down?

            const moveKeys = ['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'];
            const anyPressed = moveKeys.some(k => keysPressed[k]);

            if (!anyPressed) {
                stopMove();
            } else {
                // Re-evaluate?
                // E.g. Holding W and A, release A -> Should continue W?
                // For now, Keep it simple. If I release A but W is held, I might want to go back to Forward.
                if (keysPressed['w'] || keysPressed['arrowup']) sendMove(1, 1);
                else if (keysPressed['s'] || keysPressed['arrowdown']) sendMove(-1, -1);
                else if (keysPressed['a'] || keysPressed['arrowleft']) sendMove(-1, 1);
                else if (keysPressed['d'] || keysPressed['arrowright']) sendMove(1, -1);
            }
        });
    </script>
</body>

</html>
```